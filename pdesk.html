<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Now</title>
    <style>
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 48px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 24px;
        color: #2d3748;
      }

      h2 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #2d3748;
      }

      .description {
        color: #4a5568;
        margin-bottom: 40px;
        line-height: 1.6;
        font-size: 15px;
      }

      .form-section {
        margin-bottom: 48px;
        padding-bottom: 32px;
        border-bottom: 1px solid #e2e8f0;
      }

      .form-section:last-child {
        border-bottom: none;
        margin-bottom: 24px;
      }

      .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 32px;
      }

      .section-number {
        width: 28px;
        height: 28px;
        background: #e2e8f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 14px;
        color: #4a5568;
        font-weight: 600;
      }

      .section-title {
        font-size: 18px;
        color: #4a5568;
        font-weight: 500;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: #4a5568;
        font-weight: 500;
      }

      input,
      select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #4db6ac;
        box-shadow: 0 0 0 3px rgba(77, 182, 172, 0.1);
      }

      .error-message {
        color: #e53e3e;
        font-size: 13px;
        margin-top: 6px;
        display: none;
      }

      .price {
        font-size: 24px;
        font-weight: 600;
        margin-top: 32px;
        color: #2d3748;
        padding: 16px;
        background: #f7fafc;
        border-radius: 6px;
        text-align: right;
      }

      .submit-btn {
        background-color: #4db6ac;
        color: white;
        padding: 14px 28px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s ease;
        float: right;
      }

      .submit-btn:hover {
        background-color: #45a49a;
        transform: translateY(-1px);
      }

      .form-row {
        display: flex;
        gap: 32px;
        margin-bottom: 16px;
      }

      .form-col {
        flex: 1;
      }

      select[disabled] {
        background-color: #f7fafc;
        cursor: not-allowed;
      }

      .error {
        border-color: #e53e3e;
      }

      .error-text {
        color: #e53e3e;
        font-size: 13px;
        margin-top: 6px;
      }

      .date-range {
        color: #4a5568;
        font-size: 13px;
        margin-top: 8px;
        padding: 8px 12px;
        background: #f7fafc;
        border-radius: 4px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 32px 24px;
        }

        .form-row {
          flex-direction: column;
          gap: 20px;
        }

        .submit-btn {
          width: 100%;
          float: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Book now</h1>
      <p class="description">
        Located in a semi-private office, it's a more private experience that
        lets you focus, and make your workspace your own. Take advantage of
        all-inclusive amenities like high-speed Wi-Fi, bookable meeting rooms,
        and your own lockable filing cabine
      </p>

      <form id="bookingForm">
        <div class="form-section">
          <div class="form-group">
            <h2>Select Room</h2>
            <div class="form-group">
              <label for="room">Available Rooms:</label>
              <select id="room" required>
                <option value="">Select a room</option>
              </select>
            </div>
          </div>
          <div class="section-header">
            <div class="section-number">1</div>
            <div class="section-title">Information</div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="timeperiod">Time period</label>
                <select id="timeperiod" required>
                  <option value="">Select time period</option>
                  <option value="daily">Daily (24h)</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>

              <div class="form-group">
                <label for="firstName">First name</label>
                <input
                  type="text"
                  id="firstName"
                  placeholder="eg. John"
                  required
                />
              </div>

              <div class="form-group">
                <label for="birthDate">Birth date</label>
                <input type="date" id="birthDate" required />
              </div>

              <div class="form-group">
                <label for="email">Email</label>
                <input
                  type="email"
                  id="email"
                  placeholder="example@example.com"
                  required
                />
              </div>
            </div>

            <div class="form-col">
              <div class="form-group">
                <label for="bookingDate">Start Date</label>
                <input type="date" id="bookingDate" required />
                <div class="date-range" id="dateRange"></div>
                <div class="error-text" id="dateError" style="display: none">
                  This date is not available. Try another option
                </div>
              </div>

              <div class="form-group">
                <label for="lastName">Last name</label>
                <input
                  type="text"
                  id="lastName"
                  placeholder="eg. John"
                  required
                />
              </div>

              <!-- <div class="form-group">
                <label for="idNumber">Identification number</label>
                <input
                  type="text"
                  id="idNumber"
                  placeholder="XXXXXXXX"
                  required
                />
              </div> -->

              <div class="form-group">
                <label for="phone">Phone number</label>
                <input
                  type="tel"
                  id="phone"
                  placeholder="+355 XX XXX XXXX"
                  required
                />
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-header">
            <div class="section-number">2</div>
            <div class="section-title">Payment</div>
          </div>

          <!-- <div class="form-group">
            <label for="seatNumber">Select seat</label>
            <select id="seatNumber" required>
              <option value="">Select a seat</option>
            </select>
          </div> -->
          <button type="submit" class="submit-btn">Next</button>
        </div>

        <div class="price">5000 ALL</div>
      </form>
    </div>

    <script>
      let selectedRoomId = "";
      let availableSeats = [];
      let endDate = null;

      // Initialize the form
      async function init() {
        try {
          const response = await fetch(
            "https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/sharedrooms"
          );
          const data = await response.json();
          console.log(data);
          const roomSelect = document.getElementById("room");

          data.data.forEach((room) => {
            const option = document.createElement("option");
            option.value = room.ID;
            option.textContent = room.Name.zc_display_value;
            roomSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching rooms:", error);
        }
      }

      // Format date to dd-MMM-YYYY
      function formatDate(date) {
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const d = new Date(date);
        return `${d.getDate().toString().padStart(2, "0")}-${
          months[d.getMonth()]
        }-${d.getFullYear()}`;
      }

      // Calculate end date based on time period
      function calculateEndDate(startDate, timePeriod) {
        const start = new Date(startDate);
        const end = new Date(start);

        switch (timePeriod) {
          case "daily":
            end.setDate(start.getDate() + 1);
            break;
          case "weekly":
            end.setDate(start.getDate() + 7);
            break;
          case "monthly":
            end.setMonth(start.getMonth() + 1);
            break;
          case "yearly":
            end.setFullYear(start.getFullYear() + 1);
            break;
          default:
            return null;
        }
        return end;
      }

      // Update date range display
      function updateDateRangeDisplay() {
        const startDate = document.getElementById("bookingDate").value;
        const timePeriod = document.getElementById("timeperiod").value;
        const dateRangeElement = document.getElementById("dateRange");

        if (startDate && timePeriod) {
          endDate = calculateEndDate(startDate, timePeriod);
          if (endDate) {
            dateRangeElement.textContent = `Booking period: ${formatDate(
              startDate
            )} to ${formatDate(endDate)}`;
            dateRangeElement.style.display = "block";
          }
        } else {
          dateRangeElement.style.display = "none";
        }
      }

      async function checkAvailability() {
        const bookingDate = document.getElementById("bookingDate").value;
        const timePeriod = document.getElementById("timeperiod").value;

        if (!bookingDate || !timePeriod) return;

        endDate = calculateEndDate(bookingDate, timePeriod);
        if (!endDate) return;

        try {
          selectedRoomId = document.getElementById("room").value;
          const response = await fetch(
            `https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/sharedrooms/${selectedRoomId}?from=${formatDate(
              bookingDate
            )}&to=${formatDate(endDate)}`
          );
          const data = await response.json();
          availableSeats = data.response.availableSeats;
          console.log(data);
          console.log(availableSeats);

          //   const seatSelect = document.getElementById("seatNumber");
          //   seatSelect.innerHTML = '<option value="">Select a seat</option>';
          //   availableSeats.forEach((seat) => {
          //     const option = document.createElement("option");
          //     option.value = seat;
          //     option.textContent = `Seat ${seat}`;
          //     seatSelect.appendChild(option);
          //   });

          document.getElementById("dateError").style.display =
            availableSeats.length === 0 ? "block" : "none";
        } catch (error) {
          console.error("Error checking availability:", error);
          document.getElementById("dateError").style.display = "block";
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();

        if (!endDate) {
          alert("Please select a time period and start date");
          return;
        }

        // Create user
        const userData = {
          name: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          email: document.getElementById("email").value,
          birthday: formatDate(document.getElementById("birthDate").value),
          address: "Tirana",
          state: "Tirana",
          city: "Tirana",
          country: "Albania",
          code: "3001",
        };

        try {
          // Create user
          const userResponse = await fetch(
            "https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/rooms/user",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            }
          );
          const userData2 = await userResponse.json();
          const userId = userData2.data.ID;
          const randomSeat =
            Math.floor(Math.random() * availableSeats.length) + 1;
          console.log("Random seat", randomSeat);
          // Create booking
          const bookingData = {
            user: userId,
            room: selectedRoomId,
            phoneNumber: document.getElementById("phone").value,
            from: formatDate(document.getElementById("bookingDate").value),
            to: formatDate(endDate),
            seat: randomSeat.toString(),
          };

          const bookingResponse = await fetch(
            "https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/sharedrooms",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(bookingData),
            }
          );
          const bookingResult = await bookingResponse.json();

          if (bookingResult.code === 3000) {
            alert("Booking successful!");
            location.reload();
          } else {
            alert("Booking failed. Please try again.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("An error occurred. Please try again.");
        }
      }

      // Event listeners
      document.getElementById("bookingDate").addEventListener("change", () => {
        updateDateRangeDisplay();
        checkAvailability();
      });
      document.getElementById("timeperiod").addEventListener("change", () => {
        updateDateRangeDisplay();
        checkAvailability();
      });
      document
        .getElementById("bookingForm")
        .addEventListener("submit", handleSubmit);

      // Initialize the form
      init();
    </script>
  </body>
</html>
