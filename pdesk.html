<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Now</title>
    <style>
      .pdeskcontainer {
        background-color: white;
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }

      .pdeskcontainer h1 {
        font-size: 1.75rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
      }

      .description {
        color: #666;
        margin-bottom: 2rem;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      /* Progress Indicator */
      .progress-steps {
        display: flex;
        margin-bottom: 2.5rem;
        position: relative;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
      }

      .step {
        display: flex;
        align-items: center;
        margin-right: 2rem;
        color: #999;
      }

      .step.active {
        color: #333;
      }

      .step-number {
        width: 24px;
        height: 24px;
        background: #eee;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 0.875rem;
        color: #666;
      }

      .step.active .step-number {
        background: #4db6ac;
        color: white;
      }

      .step-label {
        font-size: 0.95rem;
        font-weight: 500;
      }

      .form-section {
        margin-bottom: 2.5rem;
      }

      .section-title {
        font-size: 1rem;
        color: #333;
        font-weight: 500;
        margin-bottom: 1.5rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95rem;
        background-color: white;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #4db6ac;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }

      .total-amount {
        margin: 2rem 0;
        font-weight: 500;
        color: #333;
      }

      .amount {
        font-size: 1.25rem;
        font-weight: 600;
      }

      .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
      }

      .btn {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 4px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
      }

      .btn-cancel {
        background-color: #eee;
        color: #666;
      }

      .btn-next {
        background-color: #4db6ac;
        color: white;
      }

      .btn:hover {
        opacity: 0.9;
      }

      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }

        .pdeskcontainer {
          padding: 1rem;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .progress-steps {
          flex-direction: column;
          gap: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="pdeskcontainer">
      <h1>Book now</h1>
      <p class="description">
        Located in a semi-private office, it's a more private experience that
        lets you focus, and make your workspace your own. Take advantage of
        all-inclusive amenities like high-speed Wi-Fi, bookable meeting rooms,
        and your own lockable filing cabinet.
      </p>

      <div class="progress-steps">
        <div class="step active">
          <div class="step-number">1</div>
          <div class="step-label">Information</div>
        </div>
        <div class="step">
          <div class="step-number">2</div>
          <div class="step-label">Payment</div>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-label">Finished</div>
        </div>
      </div>

      <form id="bookingForm">
        <div class="form-section">
          <div class="section-title">Office</div>
          <div class="form-row">
            <div class="form-group">
              <label for="room">Available Rooms:</label>
              <select id="room" required>
                <option value="">Select an office</option>
              </select>
            </div>
          </div>
          <div class="section-title">Time period</div>
          <div class="form-row">
            <div class="form-group">
              <label for="timeperiod">Time period</label>
              <select id="timeperiod" required>
                <option value="">Select time period</option>
                <option value="daily">Daily (24h)</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <div class="form-group">
              <label for="bookingDate">Select date</label>
              <input type="date" id="bookingDate" required />
              <div class="error-text" id="dateError" style="display: none">
                This date is not available. Try another option
              </div>
              <!-- Add this div to show the date range -->
              <div
                id="dateRange"
                style="display: none; font-size: 1rem; margin-top: 1rem"
              ></div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Personal Information</div>
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First name</label>
              <input type="text" id="firstName" placeholder="John" required />
            </div>
            <div class="form-group">
              <label for="lastName">Last name</label>
              <input type="text" id="lastName" placeholder="Doe" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="birthDate">Birth date</label>
              <input type="date" id="birthDate" required />
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input
                type="text"
                id="phone"
                placeholder="Enter your phone number"
                required
              />
            </div>
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              placeholder="example@example.com"
              required
            />
          </div>
        </div>

        <div class="total-amount">
          <span>Total to pay</span>
          <div class="amount">5000 ALL</div>
        </div>

        <div class="button-group">
          <button type="button" class="btn btn-cancel">Cancel</button>
          <button type="submit" class="btn btn-next">Next</button>
        </div>
      </form>
    </div>

    <script>
      let selectedRoomId = "";
      let availableSeats = [];
      let endDate = null;

      // Initialize the form
      async function init() {
        try {
          const response = await fetch(
            "https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/leads/shared"
          );
          const data = await response.json();
          //   console.log(data);
          const roomSelect = document.getElementById("room");

          data.data.forEach((room) => {
            const option = document.createElement("option");
            option.value = room.id;
            option.textContent = room.Name;
            roomSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching rooms:", error);
        }
      }

      // Format date to dd-MMM-YYYY
      function formatDate(date) {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = (d.getMonth() + 1).toString().padStart(2, "0"); // Ensure month is two digits
        const day = d.getDate().toString().padStart(2, "0"); // Ensure day is two digits
        return `${year}-${month}-${day}`;
      }

      // Calculate end date based on time period
      function calculateEndDate(startDate, timePeriod) {
        const start = new Date(startDate);
        const end = new Date(start);

        switch (timePeriod) {
          case "daily":
            end.setDate(start.getDate() + 1);
            break;
          case "weekly":
            end.setDate(start.getDate() + 7);
            break;
          case "monthly":
            end.setMonth(start.getMonth() + 1);
            break;
          case "yearly":
            end.setFullYear(start.getFullYear() + 1);
            break;
          default:
            return null;
        }
        return end;
      }

      // Update date range display
      function updateDateRangeDisplay() {
        const startDate = document.getElementById("bookingDate").value;
        const timePeriod = document.getElementById("timeperiod").value;
        const dateRangeElement = document.getElementById("dateRange");

        if (dateRangeElement) {
          if (startDate && timePeriod) {
            endDate = calculateEndDate(startDate, timePeriod);
            if (endDate) {
              dateRangeElement.textContent = `Booking period: ${formatDate(
                startDate
              )} to ${formatDate(endDate)}`;
              dateRangeElement.style.display = "block";
            }
          } else {
            dateRangeElement.style.display = "none";
          }
        } else {
          console.error("Element with id 'dateRange' not found in the DOM.");
        }
      }

      async function checkAvailability() {
        const bookingDate = document.getElementById("bookingDate").value;
        const timePeriod = document.getElementById("timeperiod").value;

        if (!bookingDate || !timePeriod) return;

        endDate = calculateEndDate(bookingDate, timePeriod);
        if (!endDate) return;
        // console.log("ðŸš€ ~ checkAvailability ~ selectedRoomId:", selectedRoomId);
        // console.log("ðŸš€ ~ checkAvailability ~", formatDate(endDate));
        try {
          selectedRoomId = document.getElementById("room").value;
          const response = await fetch(
            `https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/leads/shared/${selectedRoomId}?from=${formatDate(
              bookingDate
            )}&to=${formatDate(endDate)}`
          );
          const data = await response.json();
          //   console.log("ðŸš€ ~ checkAvailability ~ data:", data);
          availableSeats = data.availableSeats;
          //   console.log(data);
          //   console.log(availableSeats);

          //   const seatSelect = document.getElementById("seatNumber");
          //   seatSelect.innerHTML = '<option value="">Select a seat</option>';
          //   availableSeats.forEach((seat) => {
          //     const option = document.createElement("option");
          //     option.value = seat;
          //     option.textContent = `Seat ${seat}`;
          //     seatSelect.appendChild(option);
          //   });

          document.getElementById("dateError").style.display =
            availableSeats.length === 0 ? "block" : "none";
        } catch (error) {
          console.error("Error checking availability:", error);
          document.getElementById("dateError").style.display = "block";
        }
      }

      async function handleSubmit(event) {
        event.preventDefault();
        // Get the phone number element, check for its existence
        const phoneInput = document.getElementById("phone");
        const phone = phoneInput ? phoneInput.value : "";
        // console.log("ðŸš€ ~ handleSubmit ~ phone:", phone);

        if (!phone) {
          alert("Please provide a phone number.");
        }

        if (!endDate) {
          alert("Please select a time period and start date");
        }

        // Create user
        const userData = {
          name: document.getElementById("firstName").value,
          lastName: document.getElementById("lastName").value,
          email: document.getElementById("email").value,
          company: "Tegeria",
          // phone: document.getElementById("phone").value,
          phone: phone,
          birthday: formatDate(document.getElementById("birthDate").value),
          address: "Tirana",
          state: "Tirana",
          city: "Tirana",
          country: "Albania",
          code: "3001",
        };

        try {
          // Create user
          const userResponse = await fetch(
            "https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/account",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
            }
          );
          const userData2 = await userResponse.json();
          //   console.log("ðŸš€ ~ handleSubmit ~ userData2:", userData2);
          const userId = userData2.data.id;
          const randomSeat =
            Math.floor(Math.random() * availableSeats.length) + 1;
          //   console.log("Random seat", randomSeat);
          // Create booking
          const bookingData = {
            user: userId,
            room: selectedRoomId,
            phoneNumber: phone,
            from: formatDate(document.getElementById("bookingDate").value),
            to: formatDate(endDate),
            seat: randomSeat.toString(),
          };
          //   console.log("ðŸš€ ~ handleSubmit ~ bookingData:", bookingData);

          const bookingResponse = await fetch(
            "https://8ey3ox6oxi.execute-api.eu-central-1.amazonaws.com/prod/leads/shared",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(bookingData),
            }
          );
          const bookingResult = await bookingResponse.json();
          //   console.log("ðŸš€ ~ handleSubmit ~ bookingResult:", bookingResult);

          if (bookingResult.code === "SUCCESS") {
            alert("Booking successful!");
            location.reload();
          } else {
            alert("Booking failed. Please try again.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("An error occurred. Please try again.");
        }
      }

      // Event listeners
      document.getElementById("bookingDate").addEventListener("change", () => {
        updateDateRangeDisplay();
        checkAvailability();
      });
      document.getElementById("timeperiod").addEventListener("change", () => {
        updateDateRangeDisplay();
        checkAvailability();
      });
      document
        .getElementById("bookingForm")
        .addEventListener("submit", handleSubmit);

      // Initialize the form
      init();
    </script>
  </body>
</html>
